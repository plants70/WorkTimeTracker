name: CI
on: [push, pull_request]

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      GOOGLE_SHEET_NAME: WorkLog
      USERS_SHEET: Users
      ACTIVE_SESSIONS_SHEET: ActiveSessions
      CREDENTIALS_FILE: .creds/service_account.json
      SPREADSHEET_ID: 1xuxs4-lGlEIi1nvJ3EWrZj5U0SiADC1ceXKxqzFvmvs
      TELEGRAM_SILENT: "1"

    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install deps
        run: |
          python -m pip install -U pip
          pip install -r requirements.txt

      - name: Decode service account
        if: ${{ secrets.SERVICE_ACCOUNT_JSON_BASE64 != '' }}
        env:
          SERVICE_ACCOUNT_JSON_BASE64: ${{ secrets.SERVICE_ACCOUNT_JSON_BASE64 }}
        run: |
          mkdir -p .creds
          python - <<'PY'
          import os, base64, json, hashlib, pathlib
          b64 = os.environ["SERVICE_ACCOUNT_JSON_BASE64"]
          p = pathlib.Path(".creds/service_account.json")
          p.write_bytes(base64.b64decode(b64))
          sha = hashlib.sha256(p.read_bytes()).hexdigest()
          sa = json.loads(p.read_text())
          print("service_account.json restored")
          print("client_email:", sa.get("client_email"))
          print("key_id:", (sa.get("private_key_id") or "")[:6] + "â€¦")
          print("sha256:", sha)
          PY
          echo "HAVE_CREDS=1" >> $GITHUB_ENV

      - name: Compile check
        run: python -m compileall .

      - name: Smoke test (runs only when creds present)
        if: ${{ env.HAVE_CREDS == '1' }}
        run: python tools/smoke_ci.py
